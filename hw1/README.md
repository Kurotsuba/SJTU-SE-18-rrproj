# 集群调度系统笔记

## Apollo(Micrisoft)
---

### 生产环境下的调度
---

### 主要特性
- **Apollo采用分布式和松散协调的调度框架**。传统的中心式调度框架，其可扩展性有很大的限制，为了平衡可扩展性和调度质量，该工作采用了分布式的调度框架，每个调度器根据整个集群的信息独立地进行调度。
- **Apollo将每个任务的完成时间最小化**。Apollo通过估计模型来对每一个提交的作业的任务完成时间进行预估，模型中同时考虑数据的局部性、服务器负载和其他各种因素，并可以根据这些因素进行加权决策，估计模型还可以通过以往类似作业的运行信息来对时间估计进行进一步的细化。
- **每个调度器都拥有整个集群的信息，供其进行调度决策**。Apollo引入了轻量级的硬件独立机制来为调度器提供集群中所有服务器上的资源使用情况，拱调度器使用。
- **Apollo提供了一系列的校正机制**。集群中可能会出现作业运行时间估计不准确、作业冲突、运行时一些不正常的行为等意外状况，Apollo提供的校正机制可以在集群运行时动态的对其进行调整。
- **Apollo引入了机会调度（opportunistic scheduling）**。Apollo将作业分成了两类，常规作业（ regular tasks）和机会作业（ opportunistic tasks），保证常规作业的低延迟的同时使用机会作业来提高集群的利用率，并引入了基于token的机制来管理容量并通过限制常规任务的总数来避免集群的负载过高。
- Apollo的设计是为了替代生产环境中的旧调度器，因此在设计时支持分阶段部署到生产环境中并进行验证。

### Apollo整体框架
---
 ![Apollo整体结构](image/Apollo-overview.png)
>上图是Apollo的整体结构图。Job Manager（JM）就是一个调度器，它负责对作业进行调度，每一个集群都会拥有一个Resource Monitor（RM），每一台服务器都拥有一个Process Node（PN），它们两个协调工作来为调度器提供一个全局的视角，供调度器进行调度决策时使用。每个PN负责对本地服务器的资源进行管理，RM会从集群 中每个服务器上的PN那里收集信息，汇总成全局信息后给每个JM。

### 工程实践
---
### 性能评估
---

## Borg
---

## Sigma
---

## Omega
---

> Google经历了三代资源调度器的架构，分别是中央式调度器架构、双层调度器架构（如Apache Mesos与Hadoop YARN）和共享状态架构,即Omega。

 ![Google三代集群调度架构](image/Google-structures.png)

### 1、主要特性
- **Omega采用图1中第三代调度架构：共享状态调度器（Shared-state scheduler）**。每个调度器具有对整个集群的完全访问权，允许它们以**自由通行（free-for-all**）的方式进行竞争，并在更新集群状态时使用乐观并发控制来解决冲突。
- **没有中央资源分配器；所有的资源分配决定都发生在调度器中**。每个调度器都获得一个私用的、本地的、频繁更新的单元状态副本，用于作出调度决策。
- **调度器完全并行运行，不需要等待其他调度器中的工作，并且没有调度器之间的阻塞（head of line blocking）**。
- **Omega采用乐观锁并发控制**。资源申请采用“乐观锁”（即MVCC，Multi-Version Concurrency Control，多版本并发访问控制方式），优先级控制，大大提升并发性。

### 2、Omega相比其它调度方式的优势
（1）其它几种调度方式的缺点：
* 中央调度器无法扩展到大型集群的工作负载。
* 二层调度器可以支持独立的调度器实现，但是由于采用悲观锁，不能很好地处理长决策时间，并且不能调度大量混合负载。

（2）Omega的优势
* 可扩展到高批量的混合工作负载。
* “乐观锁”的应用大量减少了实际工作中的冲突干扰。
* 支持独立的调度器实现，并将整个分配状态暴露给调度器。

 ![omega与其它集群调度框架的比较](image/comparison-omega.png)
 
### 3、未来可关注并继续努力的方向
> 1. Omega方法灵活性好，若开发专用的调度器，则能发挥更大的优势。
> 2. Omega的乐观锁方法将比悲观锁方案做更多的工作，因为工作可能需要重新完成。
> 3. Omega仍是一个比较新的系统，而类似Mesos，YARN系统已经在开发中，需要继续探索全球性保障（公平性、饥饿避免等）的方法，开发出更稳定、实用的版本。
> 4. 在数据库领域中，寻求新的技术来减少长决策时间的调度器受到干扰的可能性和影响。

### 参考
1. [解析Google集群资源管理系统Omega](http://dongxicheng.org/mapreduce-nextgen/google-omega/)

-----
## Kubernetes
---
