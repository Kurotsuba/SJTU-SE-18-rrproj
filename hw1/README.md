# 集群调度系统笔记

## Apollo(Micrisoft)
---

### 生产环境下的调度
---

### 主要特性
- **Apollo采用分布式和松散协调的调度框架**。传统的中心式调度框架，其可扩展性有很大的限制，为了平衡可扩展性和调度质量，该工作采用了分布式的调度框架，每个调度器根据整个集群的信息独立地进行调度。
- **Apollo将每个任务的完成时间最小化**。Apollo通过估计模型来对每一个提交的作业的任务完成时间进行预估，模型中同时考虑数据的局部性、服务器负载和其他各种因素，并可以根据这些因素进行加权决策，估计模型还可以通过以往类似作业的运行信息来对时间估计进行进一步的细化。
- **每个调度器都拥有整个集群的信息，供其进行调度决策**。Apollo引入了轻量级的硬件独立机制来为调度器提供集群中所有服务器上的资源使用情况，拱调度器使用。
- **Apollo提供了一系列的校正机制**。集群中可能会出现作业运行时间估计不准确、作业冲突、运行时一些不正常的行为等意外状况，Apollo提供的校正机制可以在集群运行时动态的对其进行调整。
- **Apollo引入了机会调度（opportunistic scheduling）**。Apollo将作业分成了两类，常规作业（ regular tasks）和机会作业（ opportunistic tasks），保证常规作业的低延迟的同时使用机会作业来提高集群的利用率，并引入了基于token的机制来管理容量并通过限制常规任务的总数来避免集群的负载过高。
- Apollo的设计是为了替代生产环境中的旧调度器，因此在设计时支持分阶段部署到生产环境中并进行验证。

### Apollo整体框架
---
 ![Apollo整体结构](image/Apollo-overview.png)
>上图是Apollo的整体结构图。Job Manager（JM）就是一个调度器，它负责对作业进行调度，每一个集群都会拥有一个Resource Monitor（RM），每一台服务器都拥有一个Process Node（PN），它们两个协调工作来为调度器提供一个全局的视角，供调度器进行调度决策时使用。每个PN负责对本地服务器的资源进行管理，RM会从集群 中每个服务器上的PN那里收集信息，汇总成全局信息后给每个JM。

### 工程实践
---
### 性能评估
---

## Borg
---

## Sigma
---

## Omega
---

## Kubernates
---
### 主要特性
- **自动化部署**
根据应用程序的计算资源需求和其它一些限制条件，自动地将运行应用程序的容器调度到集群中指定的Node上，且不会影响应用程序的可用性。
- **系统自愈**
当Kubernetes集群中某些容器失败时，会重新启动他们。当某些Node挂掉后，Kubernetes会自动重新调度这些Node上的容器到其他可用的Node上。如果某些容器没有满足用户定义的健康检查条件，这些容器会被判定为无法正常工作的，集群会自动杀死掉这些容器。
- **水平扩展**
通过一个命令就可以实现应用程序的水平扩展，实现这个功能的是HPA（Horizontal Pod Autoscaler）对象。HPA是通过Kubernetes API Resource和Controller的方式实现的，其中Resource决定了Controller的行为，而Controller周期性地调整Replication Controller或Deployment中的副本数，使得观察到的平均CPU使用情况与用户定义的能够匹配。
- **服务发现和负载均衡**
Kubernetes会给每个容器指派一个IP地址，给一组容器指派一个DNS名称，通过这个就可以实现服务的负载均衡功能。
- **自动更新和回滚**
当应用程序发生变更，Kubernetes可以实现滚动更新，同时监控应用的状态，确保不会在同一时刻杀掉所有的实例，造成应用在一段时间范围内不可用。如果某些时候应用更新出错，Kubernetes能够自动地将应用恢复到原来正确的状态。

### 架构设计
Kubernetes的核心组件是基于资源分配的任务调度。Kubernetes的调度策略源自Borg, 但是为了更好的适应新一代的容器应用，以及各种规模的部署，Kubernetes的调度策略相应做的更加灵活，也更加容易理解和使用，如下图：
![image](http://dockone.io/uploads/article/20171115/ff7d575058bcf7bc62bf4de9064b12a6.png)

其中， Controller Manager主要用于管理计算节点（Node Controller）以及Pod副本（Replication Controller）等，Scheduler根据特定的算法和策略调度Pod到具体的计算节点，Kubelet通过apiserver或者监控本地的配置文件（eg. Kubeadm创建的Kuernetes集群），通过docker daemon创建Pod的container。

###优缺点分析
**优点**：
- 可快速地部署应用程序而无须面对传统平台所具有的风险、动态地扩展应用程序以及更佳的资源分配；
- 硬件使用率下降。由于容器的轻量特性以及更快速杀掉未使用的实体，对硬件的需求降低了40-50%；
- 面向社区而不是技术规范，这让它的功能更加强大；

**缺点**：
- 容器技术自身存在的缺点对Kubernetes能提供的服务存在影响；
- 默认的规化器依赖于应用程序属主提供的资源分配需求，而无视实时的消耗，将在每个节点上产生资源碎片；
- 容器内允许运行的负载范围不够大；

###评价
基于资源分配的任务调度是Borg和Kubernetes的核心组件，Kubernetes的调度策略源自Borg, 但是为了更好的适应新一代的容器应用，以及各种规模的部署，Kubernetes的调度策略相应做的更加灵活，也更加容易理解和使用。然而，随着容器的爆发，Kubernetes初始设置与其在生产环境中大规模运行之间存在着巨大的鸿沟。未来几年，在管理这些部署和负载方面，它将面临第三方强有力的竞争如果其社区能正确地扩展该平台，Kubernetes的未来一片文明。